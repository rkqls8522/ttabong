services:
  mysqlc:
    build:
      context: ./docker/mysql
    image: mysql
    container_name: mysqldeploy
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ddabong_db
      MYSQL_USER: ddabong
      MYSQL_PASSWORD: 707
    networks:
      - internal # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì—°ê²°
    expose:
      - "3306" # ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ë¶ˆê°€ëŠ¥, ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥

  rabbitmqc:
    build:
      context: ./docker/rabbitmq
    image: rabbitmq
    container_name: rabbitmqdeploy
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password
    networks:
      - internal
    expose:
      - "5672"
      - "15672"

  redisc:
    build:
      context: ./docker/redis
    image: redis
    container_name: redisdeploy
    restart: always
    networks:
      - internal
    expose:
      - "6379"

  springc:
    build:
      context: ./backend/ttabong
    image: spring
    container_name: springdeploy
    environment:
      SPRING_PROFILES_ACTIVE: prod
    restart: always
    depends_on:
      - mysqlc
      - redisc
      - rabbitmqc
    networks:
      - internal
    expose:
      - "8080" # ì™¸ë¶€ì— ì§ì ‘ ê³µê°œë˜ì§€ ì•Šê³  ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
  minio:
    build:
      context: ./docker/minio
      dockerfile: Dockerfile
    image: minio
    container_name: minio_deploy
    restart: always
    ports:
      - "8000:9000"
      - "8001:9001"
    networks:
      - external
  nginxc:
    build:
      context: ./frontend/ttabong
    image: nginx
    container_name: nginxdeploy
    restart: no
    volumes:
      - certbot-etc:/etc/letsencrypt # ì¸ì¦ì„œ ë°ì´í„° ìœ ì§€
      #- ./frontend/ttabong/nginx.conf:/etc/nginx/nginx.conf # Nginx ì„¤ì • ìœ ì§€
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    depends_on:
      #  - frontend
      - springc
      - certbot
    ports:
      - "80:80" # ì™¸ë¶€ì—ì„œ HTTP ì ‘ê·¼ í—ˆìš©
      - "443:443" # ì™¸ë¶€ì—ì„œ HTTPS ì ‘ê·¼ í—ˆìš© (í•„ìš” ì‹œ)
    networks:
      - internal # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì—°ê²° (Backend, Frontend ì—°ê²°)
      - external
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - external
networks:
  internal:
    driver: bridge
    internal: true # ğŸ”¥ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì´ë¯€ë¡œ ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨
  external:
    driver: bridge # ğŸ”¥ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥ (nginxë§Œ ì—°ê²°)

volumes:
  mysql_data:
  rabbitmq_data:
  redis_data:
  certbot-etc:
  #frontend:
  #  build:
  #    context: ./frontend/ttabong
  #    dockerfile: Dockerfile
  #  image: frontend_builder
  #  container_name: frontend_deploy
  #  networks:
  #    - internal
  #  expose:
  #    - "3000" # ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨, ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
