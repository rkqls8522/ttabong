services:
  mysqlc:
    build:
      context: ./docker/mysql
    platform: "linux/amd64"
    image: ${DOCKER_HUB_USERNAME}/ttabong:$CI_PIPELINE_ID-mysql
    container_name: mysqldeploy
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: volunteer_service
      MYSQL_USER: ddabong
      MYSQL_PASSWORD: 707
    networks:
      - internal # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì—°ê²°
    expose:
      - "3306" # ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ë¶ˆê°€ëŠ¥, ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥

  rabbitmqc:
    build:
      context: ./docker/rabbitmq
    platform: "linux/amd64"
    image: ${DOCKER_HUB_USERNAME}/ttabong:$CI_PIPELINE_ID-rabbitmq
    container_name: rabbitmqdeploy
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: user
      RABBITMQ_DEFAULT_PASS: password
    networks:
      - internal
    expose:
      - "5672"
      - "15672"

  redisc:
    build:
      context: ./docker/redis
    platform: "linux/amd64"
    image: ${DOCKER_HUB_USERNAME}/ttabong:$CI_PIPELINE_ID-redis
    container_name: redisdeploy
    restart: always
    networks:
      - internal
    expose:
      - "6379"

  springc:
    build:
      context: ./backend/ttabong
    platform: "linux/amd64"
    image: ${DOCKER_HUB_USERNAME}/ttabong:$CI_PIPELINE_ID-spring
    container_name: springdeploy
    environment:
      SPRING_PROFILES_ACTIVE: prod
    restart: always
    depends_on:
      - mysqlc
      - redisc
      - rabbitmqc
    networks:
      - internal
    expose:
      - "8080" # ì™¸ë¶€ì— ì§ì ‘ ê³µê°œë˜ì§€ ì•Šê³  ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ ì ‘ê·¼
  minio:
    build:
      context: ./docker/minio
      dockerfile: Dockerfile
    platform: "linux/amd64"
    image: ${DOCKER_HUB_USERNAME}/ttabong:$CI_PIPELINE_ID-minio
    container_name: minio_deploy
    restart: always
    ports:
      - "8000:9000"
      - "8001:9001"
    networks:
      - external
  nginxc:
    build:
      context: ./frontend/ttabong
    platform: "linux/amd64"
    image: ${DOCKER_HUB_USERNAME}/ttabong:$CI_PIPELINE_ID-nginx
    container_name: nginxdeploy
    restart: no
    volumes:
      - certbot-etc:/etc/letsencrypt # ì¸ì¦ì„œ ë°ì´í„° ìœ ì§€
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    depends_on:
      #  - frontend
      - springc
      - certbot
    ports:
      - "80:80" # ì™¸ë¶€ì—ì„œ HTTP ì ‘ê·¼ í—ˆìš©
      - "443:443" # ì™¸ë¶€ì—ì„œ HTTPS ì ‘ê·¼ í—ˆìš© (í•„ìš” ì‹œ)
    networks:
      - internal # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ì—°ê²° (Backend, Frontend ì—°ê²°)
      - external
  certbot:
    build:
      context: ./docker/certbot # í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ ë¹Œë“œ
    image: ${DOCKER_HUB_USERNAME}/ttabong:$CI_PIPELINE_ID-certbot
    container_name: certbot
    platform: "linux/amd64"
    volumes:
      - certbot-etc:/etc/letsencrypt # ê°™ì€ ë³¼ë¥¨ ì‚¬ìš©
      - ./data/certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - external
networks:
  internal:
    driver: bridge
    #internal: true # ğŸ”¥ ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì´ë¯€ë¡œ ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨
  external:
    driver: bridge # ğŸ”¥ ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥ (nginxë§Œì—°ê²°)

volumes:
  mysql_data:
  rabbitmq_data:
  redis_data:
  certbot-etc:
  #frontend:
  #  build:
  #    context: ./frontend/ttabong
  #    dockerfile: Dockerfile
  #  image: frontend_builder
  #  container_name: frontend_deploy
  #  networks:
  #    - internal
  #  expose:
  #    - "3000" # ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨, ë‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
